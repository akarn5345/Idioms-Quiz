<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Idioms Quiz</title>
  <!-- (Style block unchanged) -->
</head>
<body>
  <!-- (Body content unchanged up to script block) -->

  <script>
    let quizData = [];
    let usedQuestions = new Set();
    let score = 0;
    let selectedQuestions = [];
    let fontSize = 16;
    const questionPrompts = [
      "Which of these is the correct idiom?",
      "Pick the right idiom:",
      "Choose the correct idiom:",
      "Spot the correct idiom:",
      "Correct idiom:"
    ];

    let timerInterval = null;
    let timeLeft = 600;

    function displayTimer() {
      const timerDiv = document.getElementById('timer');
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDiv.textContent = `Time Left: ${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    function startTimer() {
      displayTimer();
      document.getElementById('timer').style.display = 'block';
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        timeLeft--;
        displayTimer();
        if (timeLeft <= 0) {
          clearInterval(timerInterval);
          endQuizDueToTimeout();
        }
      }, 1000);
    }

    function endQuizDueToTimeout() {
      document.querySelectorAll('.question-block button').forEach(btn => btn.disabled = true);
      const resultMsg = document.getElementById('result-msg');
      resultMsg.textContent = "⏰ Time's up!";
      resultMsg.style.color = "orange";
    }

    async function startQuiz() {
      const res = await fetch('idioms_data.json');
      const data = await res.json();
      const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
      const selectedYears = Array.from(checkboxes).map(cb => cb.value);

      const countRadios = document.querySelectorAll('input[name="question-count"]:checked');
      const questionCount = countRadios.length ? parseInt(countRadios[0].value) : 25;

      if (questionCount === 50) {
        timeLeft = 1200;
      } else {
        timeLeft = 600;
      }

      if (selectedYears.length === 0) {
        alert("Please select at least one year.");
        return;
      }

      quizData = data.questions.filter(q => selectedYears.includes(String(q.year)));
      if (quizData.length === 0) {
        document.getElementById('quiz-container').innerHTML = '<p>No idioms found for selected years.</p>';
        document.getElementById('timer').style.display = 'none';
        return;
      }

      shuffleArray(quizData);
      selectedQuestions = quizData.filter(q => !usedQuestions.has(q.correct_idiom)).slice(0, questionCount);
      selectedQuestions.forEach(q => usedQuestions.add(q.correct_idiom));
      score = 0;

      displayAllQuestions();
      startTimer();
    }

    function displayAllQuestions() {
      const container = document.getElementById('quiz-container');
      container.innerHTML = '';
      selectedQuestions.forEach((q, index) => {
        const prompt = questionPrompts[Math.floor(Math.random() * questionPrompts.length)];
        const div = document.createElement('div');
        div.className = 'question-block';
        div.innerHTML = `
          <h3>Q${index + 1}. <strong>${q.correct_idiom}</strong></h3>
          <ul>
            ${Object.entries(q.options).map(([key, val]) => `
              <li>
                <button data-correct="${key === q.correct_letter}" data-key="${key}" data-value="${val}" onclick="checkAnswer(this, '${q.correct_letter}')">${val}</button>
              </li>
            `).join('')}
          </ul>
        `;
        container.appendChild(div);
      });

      const scoreDiv = document.createElement('div');
      scoreDiv.className = 'score';
      scoreDiv.textContent = `Score: 0 / ${selectedQuestions.length}`;
      container.appendChild(scoreDiv);

      const resultDiv = document.createElement('div');
      resultDiv.className = 'result';
      resultDiv.id = 'result-msg';
      container.appendChild(resultDiv);
    }

    function checkAnswer(btn, correctLetter) {
      const questionBlock = btn.closest('.question-block');
      const buttons = questionBlock.querySelectorAll("button");
      buttons.forEach(b => b.disabled = true);

      buttons.forEach(b => {
        b.classList.remove('correct-answer', 'selected-wrong', 'dimmed');
        if (b.dataset.key === correctLetter) {
          b.classList.add('correct-answer');
        } else if (b === btn) {
          b.classList.add('selected-wrong');
        } else {
          b.classList.add('dimmed');
        }
      });

      if (btn.dataset.key === correctLetter) {
        score++;
      }

      const scoreDiv = document.querySelector('.score');
      if (scoreDiv) {
        scoreDiv.textContent = `Score: ${score} / ${selectedQuestions.length}`;
      }

      const questionIndex = Array.from(document.querySelectorAll('.question-block')).indexOf(questionBlock);
      const hindiMeaning = selectedQuestions[questionIndex].hindi_meaning || 'कोई अर्थ उपलब्ध नहीं';

      let oldHindiDiv = questionBlock.querySelector('.hindi-meaning-div');
      if (oldHindiDiv) oldHindiDiv.remove();

      const hindiDiv = document.createElement('div');
      hindiDiv.className = 'hindi-meaning-div';
      hindiDiv.textContent = hindiMeaning;
      const correctBtn = Array.from(buttons).find(b => b.dataset.key === correctLetter);
      correctBtn.parentElement.appendChild(hindiDiv);

      const allButtons = document.querySelectorAll('.question-block button:not([disabled])');
      if (allButtons.length === 0) {
        if (timerInterval) clearInterval(timerInterval);
        const resultMsg = document.getElementById('result-msg');
        const percent = (score / selectedQuestions.length) * 100;
        resultMsg.textContent = percent >= 50 ? "✅ Passed!" : "❌ Failed. Try Again.";
        resultMsg.style.color = percent >= 50 ? "green" : "red";
      }
    }

    function adjustFontSize(change) {
      fontSize += change;
      document.querySelectorAll('.question-block').forEach(el => {
        el.style.fontSize = fontSize + 'px';
      });
    }

    function shuffleArray(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }
  </script>
</body>
</html>
